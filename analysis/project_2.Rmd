---
title: "Project-2: SCEPTRE"
site: workflowr::wflow_site
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 1. Understand SCEPTRE

### a. Read the paper

[Barry *et al.* 2021: SCEPTRE](https://chenh19.github.io/rotation2/refs/Barry_2021.pdf)

![dispersion](https://raw.githubusercontent.com/chenh19/rotation2/main/output/SCEPTRE/dispersion.png)  

**Some key ideas:**  

- A key confounder for perturb-seq is the read depth: ```total gRNA per cell``` seems to show a non-linear increase as ```total UMI per cell``` increases
- To overcome this, Barry *et al.* adopted two main strategies:
  - include depth as a covariate when doing negative binomial (NB) regression for gRNA and expression
  - generate an empirical null distribution by randomization test

Pipeline:

  - negative binomial regression to get z-values for each gRNA-Expression pairs
  - logistic regression to get gRNA detection probabilities for each gRNA in each cell
  - conditional randomization test to get the empirical null distribution (when doing randomization, use the gRNA detection probabilities as the conditions)
  - fit a skew-t distribution to calculate the p-values from z-values and the null distribution

From [Morris *et al.* 2021: STING-Seq](https://chenh19.github.io/rotation2/refs/Morris_2020.pdf)

### b. Check the package

- [Katsevich-Lab/sceptre](https://github.com/Katsevich-Lab/sceptre)
- [Katsevich-Lab/sceptre-manuscript](https://github.com/Katsevich-Lab/sceptre-manuscript)

### c. Install the package

**Code:** [```sceptre.sh```](https://raw.githubusercontent.com/chenh19/rotation2/main/code/0_prepare/sceptre.sh)  

### d. run sceptre

- **SCEPTRE [tutorial](https://katsevich-lab.github.io/sceptre/articles/using_sceptre_v2.html)**
- **SCEPTRE [functions](https://katsevich-lab.github.io/sceptre/reference/index.html)**

```{r,eval=FALSE}
Expression <- readRDS("../Morris_2021/filter/Expression.rds", refhook = NULL)
gRNA <- readRDS("../Morris_2021/filter/gRNA.rds", refhook = NULL)

gene_matrix <- Expression@assays$RNA@counts
gRNA_matrix <- gRNA@assays$RNA@counts

```

```{r,eval=FALSE}
#install.packages("devtools")
#devtools::install_github("katsevich-lab/sceptre")
#install.packages("tidyverse")
#install.packages("cowplot")

library(tidyverse)
library(cowplot)
library(Matrix)
library(sceptre)
```